name: Build Buf Plugins

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      DOCKER_BUILDKIT: "1"
    steps:
      - name: Clone bufbuild/plugins
        run: git clone --depth 1 https://github.com/bufbuild/plugins.git

      - name: Build grpc-cpp
        run: docker build -t grpc-cpp -f plugins/plugins/grpc/cpp/v1.78.1/Dockerfile plugins/plugins/grpc/cpp/v1.78.1

      - name: Build grpc-csharp
        run: docker build -t grpc-csharp -f plugins/plugins/grpc/csharp/v1.78.1/Dockerfile plugins/plugins/grpc/csharp/v1.78.1

      - name: Build grpc-python
        run: docker build -t grpc-python -f plugins/plugins/grpc/python/v1.78.1/Dockerfile plugins/plugins/grpc/python/v1.78.1

      - name: Build protoc-cpp
        run: docker build -t protoc-cpp -f plugins/plugins/protocolbuffers/cpp/v33.5/Dockerfile plugins/plugins/protocolbuffers/cpp/v33.5

      - name: Build protoc-csharp
        run: docker build -t protoc-csharp -f plugins/plugins/protocolbuffers/csharp/v33.5/Dockerfile plugins/plugins/protocolbuffers/csharp/v33.5

      - name: Build protoc-python
        run: docker build -t protoc-python -f plugins/plugins/protocolbuffers/python/v33.5/Dockerfile plugins/plugins/protocolbuffers/python/v33.5

      - name: Extract executables
        run: |
          extract() {
            local image=$1 path=$2 output=$3
            id=$(docker create "$image")
            docker cp "$id:$path" "$output"
            docker rm "$id"
          }
          extract grpc-cpp /grpc_cpp_plugin_binary grpc_cpp_plugin_binary
          extract grpc-csharp /grpc_csharp_plugin_binary grpc_csharp_plugin_binary
          extract grpc-python /grpc_python_plugin_binary grpc_python_plugin_binary
          extract protoc-cpp /protoc-gen-cpp protoc-gen-cpp
          extract protoc-csharp /protoc-gen-csharp protoc-gen-csharp
          extract protoc-python /protoc-gen-python protoc-gen-python

      - name: Create plugins.txt
        run: |
          printf '%s\n' \
            'plugins/grpc/cpp/v1.78.1/Dockerfile' \
            'plugins/grpc/csharp/v1.78.1/Dockerfile' \
            'plugins/grpc/python/v1.78.1/Dockerfile' \
            'plugins/protocolbuffers/cpp/v33.5/Dockerfile' \
            'plugins/protocolbuffers/csharp/v33.5/Dockerfile' \
            'plugins/protocolbuffers/python/v33.5/Dockerfile' \
            > plugins.txt

      - name: Create tarball
        run: |
          tar -czf plugins.tar.gz \
            grpc_cpp_plugin_binary \
            grpc_csharp_plugin_binary \
            grpc_python_plugin_binary \
            protoc-gen-cpp \
            protoc-gen-csharp \
            protoc-gen-python \
            plugins.txt

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=$(date +%Y%m%d)
          gh release create "$TAG" plugins.tar.gz --repo "$GITHUB_REPOSITORY" --title "$TAG" --notes "Automated build of buf plugin executables"
