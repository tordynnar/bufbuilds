name: Build Buf Plugins

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      DOCKER_BUILDKIT: "1"
    steps:
      - name: Clone bufbuild/plugins
        run: git clone --depth 1 https://github.com/bufbuild/plugins.git

      - name: Patch protocolbuffers Dockerfiles (clean Bazel sandbox between builds)
        run: |
          for f in plugins/plugins/protocolbuffers/*/v33.4/Dockerfile; do
            sed -i '/\/\/plugins:/s/RUN bazelisk/RUN rm -rf .cache\/bazel\/*\/*\/sandbox \&\& bazelisk/' "$f"
          done

      - name: Build protoc-cpp
        run: docker build -t protoc-cpp -f plugins/plugins/protocolbuffers/cpp/v33.4/Dockerfile plugins/plugins/protocolbuffers/cpp/v33.4

      - name: Build protoc-csharp
        run: docker build -t protoc-csharp -f plugins/plugins/protocolbuffers/csharp/v33.4/Dockerfile plugins/plugins/protocolbuffers/csharp/v33.4

      - name: Build protoc-python
        run: docker build -t protoc-python -f plugins/plugins/protocolbuffers/python/v33.4/Dockerfile plugins/plugins/protocolbuffers/python/v33.4

      - name: Build grpc-cpp
        run: docker build -t grpc-cpp -f plugins/plugins/grpc/cpp/v1.76.0/Dockerfile plugins/plugins/grpc/cpp/v1.76.0

      - name: Build grpc-csharp
        run: docker build -t grpc-csharp -f plugins/plugins/grpc/csharp/v1.76.0/Dockerfile plugins/plugins/grpc/csharp/v1.76.0

      - name: Build grpc-python
        run: docker build -t grpc-python -f plugins/plugins/grpc/python/v1.76.0/Dockerfile plugins/plugins/grpc/python/v1.76.0

      - name: Extract executables
        run: |
          extract() {
            local image=$1 path=$2 output=$3
            id=$(docker create "$image")
            docker cp "$id:$path" "$output"
            docker rm "$id"
          }
          extract protoc-cpp /protoc-gen-cpp protoc-gen-cpp
          extract protoc-csharp /protoc-gen-csharp protoc-gen-csharp
          extract protoc-python /protoc-gen-python protoc-gen-python
          extract grpc-cpp /grpc_cpp_plugin_binary grpc_cpp_plugin_binary
          extract grpc-csharp /grpc_csharp_plugin_binary grpc_csharp_plugin_binary
          extract grpc-python /grpc_python_plugin_binary grpc_python_plugin_binary

      - name: Collect buf.plugin.yaml files
        run: |
          cp plugins/plugins/protocolbuffers/cpp/v33.4/buf.plugin.yaml protoc-cpp.buf.plugin.yaml
          cp plugins/plugins/protocolbuffers/csharp/v33.4/buf.plugin.yaml protoc-csharp.buf.plugin.yaml
          cp plugins/plugins/protocolbuffers/python/v33.4/buf.plugin.yaml protoc-python.buf.plugin.yaml
          cp plugins/plugins/grpc/cpp/v1.76.0/buf.plugin.yaml grpc-cpp.buf.plugin.yaml
          cp plugins/plugins/grpc/csharp/v1.76.0/buf.plugin.yaml grpc-csharp.buf.plugin.yaml
          cp plugins/plugins/grpc/python/v1.76.0/buf.plugin.yaml grpc-python.buf.plugin.yaml

      - name: Create plugins.txt
        run: |
          printf '%s\n' \
            'plugins/protocolbuffers/cpp/v33.4/Dockerfile' \
            'plugins/protocolbuffers/csharp/v33.4/Dockerfile' \
            'plugins/protocolbuffers/python/v33.4/Dockerfile' \
            'plugins/grpc/cpp/v1.76.0/Dockerfile' \
            'plugins/grpc/csharp/v1.76.0/Dockerfile' \
            'plugins/grpc/python/v1.76.0/Dockerfile' \
            > plugins.txt

      - name: Create tarball
        run: |
          tar -czf plugins.tar.gz \
            protoc-gen-cpp \
            protoc-gen-csharp \
            protoc-gen-python \
            grpc_cpp_plugin_binary \
            grpc_csharp_plugin_binary \
            grpc_python_plugin_binary \
            protoc-cpp.buf.plugin.yaml \
            protoc-csharp.buf.plugin.yaml \
            protoc-python.buf.plugin.yaml \
            grpc-cpp.buf.plugin.yaml \
            grpc-csharp.buf.plugin.yaml \
            grpc-python.buf.plugin.yaml \
            plugins.txt

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=$(date +%Y%m%d)
          gh release create "$TAG" plugins.tar.gz --repo "$GITHUB_REPOSITORY" --title "$TAG" --notes "Automated build of buf plugin executables"
